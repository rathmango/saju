=======================
사주 분석의 기본 원리와 구성 요소
=======================

1. 사주의 기본 개념
----------------
- 사주(四柱)는 태어난 연월일시를 천간(天干)과 지지(地支)로 표현한 여덟 글자로 구성
- 연주(年柱), 월주(月柱), 일주(日柱), 시주(時柱)의 네 개 기둥(사주)으로 구성되어 사주팔자라고 함
- 각 기둥은 천간과 지지 두 글자로 이루어져 총 8자가 됨

2. 기본 수집 정보
-------------
- 출생 년월일시(양력 또는 음력)
- 출생 장소(시간대와 위도/경도 고려)
- 성별

3. 사주 도출 과정
-------------
### 출생 정보 변환
- 음력 생년월일 사용 시 양력으로 변환(만세력 사용)
- 태어난 날짜와 시간을 정확히 기록

### 사주 작성
- 연주: 태어난 해를 천간-지지로 표기
- 월주: 태어난 월을 천간-지지로 표기
- 일주: 태어난 일을 천간-지지로 표기
- 시주: 태어난 시를 천간-지지로 표기

4. 사주의 구성 요소
--------------
### 4.1. 천간(天干)
- 10개: 갑(甲), 을(乙), 병(丙), 정(丁), 무(戊), 기(己), 경(庚), 신(辛), 임(壬), 계(癸)
- 오행 속성:
  - 갑, 을: 목(木)
  - 병, 정: 화(火)
  - 무, 기: 토(土)
  - 경, 신: 금(金)
  - 임, 계: 수(水)

### 4.2. 지지(地支)
- 12개: 자(子), 축(丑), 인(寅), 묘(卯), 진(辰), 사(巳), 오(午), 미(未), 신(申), 유(酉), 술(戌), 해(亥)
- 12지 동물: 쥐, 소, 호랑이, 토끼, 용, 뱀, 말, 양, 원숭이, 닭, 개, 돼지
- 오행 속성:
  - 인, 묘: 목(木)
  - 사, 오: 화(火)
  - 진, 술, 축, 미: 토(土)
  - 신, 유: 금(金)
  - 자, 해: 수(水)

### 4.3. 일간(日干)
- 일주의 천간으로 사주의 주인공을 의미
- 모든 사주 분석의 기준점

### 4.4. 오행(五行)
- 목(木), 화(火), 토(土), 금(金), 수(水)
- 상생: 목생화, 화생토, 토생금, 금생수, 수생목
- 상극: 목극토, 토극수, 수극화, 화극금, 금극목

### 4.5. 십이운성(十二運星)
- 사주에 나타나는 12가지 운의 기운: 장생, 목욕, 관대, 임관, 대왕, 쇠, 병, 사, 묘, 절, 태, 양

5. 사주 분석 방법
-------------
### 5.1. 일간 확인
- 사주팔자에서 일간(日干) 확인
- 일간의 오행과 강약 분석

### 5.2. 오행 분석
- 사주 내 오행 균형 및 개수 확인
- 과다/부족한 오행 파악
- 일간과 오행 관계 분석

### 5.3. 십신(十神) 분석
- 일간을 기준으로 다른 천간들과의 관계를 십신으로 표현
- 주요 십신:
  - 비견, 겁재, 식신, 상관, 재성, 편재, 정관, 편관(칠살), 정인, 편인

### 5.4. 육친(六親) 분석
- 비견/겁재: 형제, 동료, 경쟁자
- 식신/상관: 자식, 창의력, 표현력
- 재성/편재: 배우자, 재물, 이성
- 정관/편관: 권위, 지위, 경쟁, 스트레스
- 정인/편인: 학문, 지식, 모성, 보호

### 5.5. 신살(神殺) 분석
- 합, 충, 형, 해, 파 등 관계 분석 및 길흉 판단

### 5.6. 운의 흐름 분석
- 대운: 출생 월주 기준, 성별과 천간의 양/음에 따라 순행/역행 결정, 10년 단위로 변화
- 세운: 매년 변화, 해당 연도 천간지지와 사주 상호작용 분석

6. 종합 판단 과정
--------------
- 사주의 기본 격국 파악 및 일간 강약, 용신과 극신 확인
- 대운과 세운의 영향 분석
- 건강, 재물, 직업, 혼인, 자녀 등 분야별 분석
- 장점과 단점, 특별한 운기, 길운/흉운 시기 도출

7. 실제 사주 분석 예시
----------------
**1990년 4월 15일 오전 9시 출생**

- 연주: 경오(庚午)
- 월주: 계사(癸巳)
- 일주: 경술(庚戌)
- 시주: 병진(丙辰)
- 일간: 경(庚)

**일간 분석**  
경금(庚金) 일간, 금의 성질  
봄(4월) 출생 → 금은 약함

**오행 분석**  
목: 0개  
화: 2개 (오, 사)  
토: 2개 (술, 진)  
금: 2개 (경, 경)  
수: 2개 (계, 계)

**용신과 흉신**  
용신: 토(土)  
희신: 금(金)  
흉신: 화(火)

**대운 흐름**  
남자, 경금 일간(양간) → 순행  
대운: 갑진 > 을사 > 병오 > 정미 > 무신...



=======================
# 사주(四柱) 계산 방법 개발 가이드
=======================

## 1. 기본 데이터 수집 및 변환

### 입력 데이터
- 출생 연월일시(양력/음력)
- 출생 장소(위도/경도)
- 성별

### 기본 변환 과정
1. 음력 출생일은 반드시 양력으로 변환
2. 24시간제 시간으로 변환
3. 태양시 보정(시간대 및 경도에 따른 지방시 보정)

---

## 2. 사주 구성요소 계산 알고리즘

### 2.1 천간(天干) 계산

#### 연주 천간
- 연도 % 10에 따라 결정  
  1: 갑(甲), 2: 을(乙), 3: 병(丙), 4: 정(丁), 5: 무(戊),  
  6: 기(己), 7: 경(庚), 8: 신(辛), 9: 임(壬), 0: 계(癸)  
  예: 2023 % 10 = 3 → 병(丙)

#### 월주 천간
- 연간과 계절성에 따라 결정  
- 연간별 월간 매핑:  
  - 갑(甲)·기(己): 병(丙)→정(丁)→무(戊)→기(己)→경(庚)→신(辛)...
  - 을(乙)·경(庚): 무(戊)→기(己)→경(庚)→신(辛)...
  - 병(丙)·신(辛): 경(庚)→신(辛)→임(壬)→계(癸)...
  - 정(丁)·임(壬): 임(壬)→계(癸)→갑(甲)→을(乙)...
  - 무(戊)·계(癸): 갑(甲)→을(乙)→병(丙)→정(丁)...
- 첫 번째 간지는 홀수 월, 두 번째는 짝수 월 적용

#### 일주 천간
- 기준일(0000.1.1)의 일간: 갑(甲)
- 목표일까지의 일수 계산 후 (일수+1) % 10

#### 시주 천간
- 일간과 12지지 조합으로 결정  
- 일간이 갑(甲)·기(己): 자(子)·묘(卯)·오(午)·유(酉)시는 갑(甲), 나머지는 을(乙)부터 순차  
- 기타 일간도 유사 규칙 적용

---

### 2.2 지지(地支) 계산

#### 연주 지지
- 연도 % 12에 따라 결정  
  1: 유(酉), 2: 술(戌), 3: 해(亥), 4: 자(子), 5: 축(丑), 6: 인(寅),  
  7: 묘(卯), 8: 진(辰), 9: 사(巳), 10: 오(午), 11: 미(未), 0: 신(申)  
  예: 2023 % 12 = 11 → 미(未)

#### 월주 지지
- 1월: 인(寅), 2월: 묘(卯), 3월: 진(辰), 4월: 사(巳), 5월: 오(午), 6월: 미(未),  
  7월: 신(申), 8월: 유(酉), 9월: 술(戌), 10월: 해(亥), 11월: 자(子), 12월: 축(丑)  
- 음력 윤달은 전월과 동일 지지 사용

#### 일주 지지
- 기준일(0000.1.1)의 일지: 자(子)
- (일수+1) % 12

#### 시주 지지
- 24시간을 12등분하여 배정  
  23:00-00:59: 자(子), 01:00-02:59: 축(丑), 03:00-04:59: 인(寅), ... 21:00-22:59: 해(亥)

---

### 2.3 일간(日干) 추출
- 일주의 천간이 곧 일간

---

### 2.4 오행(五行) 배속
- 천간 오행  
  - 갑, 을: 목(木)  
  - 병, 정: 화(火)  
  - 무, 기: 토(土)  
  - 경, 신: 금(金)  
  - 임, 계: 수(水)
- 지지 오행  
  - 인, 묘: 목(木)  
  - 사, 오: 화(火)  
  - 진, 술, 축, 미: 토(土)  
  - 신, 유: 금(金)  
  - 자, 해: 수(水)

---

### 2.5 십이운성(十二運星) 계산
- 일간의 오행에 따라 십이운성 시작점 결정  
- 일간별 장생 시작점:  
  - 갑·을(목): 해(亥)  
  - 병·정(화): 인(寅)  
  - 무·기(토): 묘(卯)  
  - 경·신(금): 오(午)  
  - 임·계(수): 신(申)  
- 양간(갑,병,무,경,임): 정방향, 음간(을,정,기,신,계): 역방향

---

## 3. 대운(大運) 계산

### 3.1 대운 시작점 결정
- 출생 월주 위치와 성별에 따라 순행/역행  
  - 남자 양간 or 여자 음간: 순행  
  - 남자 음간 or 여자 양간: 역행

- 대운 시작 시기  
  - 출생 월일과 절기 일자 차이 계산  
  - 남: 3일=1개월, 여: 1개월=3일로 변환  
  - 초대운 = 출생일 + 변환일수

- 대운 간지: 월주간지를 기준으로 10년씩 순행/역행

---

## 4. 코드 구현 주요 함수

```python
def solar_to_lunar(year, month, day):
    # 양력을 음력으로 변환 (외부 API 활용 권장)
    pass

def get_stem_branch_year(year):
    stem_idx = (year - 4) % 10
    branch_idx = (year - 4) % 12
    stems = ["갑", "을", "병", "정", "무", "기", "경", "신", "임", "계"]
    branches = ["자", "축", "인", "묘", "진", "사", "오", "미", "신", "유", "술", "해"]
    return stems[stem_idx], branches[branch_idx]

def get_stem_branch_month(year_stem, month):
    stems = ["갑", "을", "병", "정", "무", "기", "경", "신", "임", "계"]
    branches = ["인", "묘", "진", "사", "오", "미", "신", "유", "술", "해", "자", "축"]
    stem_map = {
        "갑": [2, 4, 6, 8, 0, 2, 4, 6, 8, 0, 2, 4],
        "을": [4, 6, 8, 0, 2, 4, 6, 8, 0, 2, 4, 6],
        "병": [6, 8, 0, 2, 4, 6, 8, 0, 2, 4, 6, 8],
        "정": [8, 0, 2, 4, 6, 8, 0, 2, 4, 6, 8, 0],
        "무": [0, 2, 4, 6, 8, 0, 2, 4, 6, 8, 0, 2],
        "기": [2, 4, 6, 8, 0, 2, 4, 6, 8, 0, 2, 4],
        "경": [4, 6, 8, 0, 2, 4, 6, 8, 0, 2, 4, 6],
        "신": [6, 8, 0, 2, 4, 6, 8, 0, 2, 4, 6, 8],
        "임": [8, 0, 2, 4, 6, 8, 0, 2, 4, 6, 8, 0],
        "계": [0, 2, 4, 6, 8, 0, 2, 4, 6, 8, 0, 2]
    }
    stem_idx = stem_map[year_stem][month-1]
    return stems[stem_idx], branches[month-1]

def get_stem_branch_day(year, month, day):
    from datetime import date
    base_date = date(1900, 1, 1)
    target_date = date(year, month, day)
    days_passed = (target_date - base_date).days
    stems = ["갑", "을", "병", "정", "무", "기", "경", "신", "임", "계"]
    branches = ["자", "축", "인", "묘", "진", "사", "오", "미", "신", "유", "술", "해"]
    return stems[days_passed % 10], branches[days_passed % 12]

def get_stem_branch_hour(day_stem, hour):
    stems = ["갑", "을", "병", "정", "무", "기", "경", "신", "임", "계"]
    branches = ["자", "축", "인", "묘", "진", "사", "오", "미", "신", "유", "술", "해"]
    branch_map = {
        0: 0, 1: 0, 2: 1, 3: 1, 4: 2, 5: 2, 6: 3, 7: 3,
        8: 4, 9: 4, 10: 5, 11: 5, 12: 6, 13: 6, 14: 7, 15: 7,
        16: 8, 17: 8, 18: 9, 19: 9, 20: 10, 21: 10, 22: 11, 23: 11
    }
    branch_idx = branch_map[hour]
    stem_map = {
        "갑": [0, 2, 4, 6, 8, 0, 2, 4, 6, 8, 0, 2],
        "을": [1, 3, 5, 7, 9, 1, 3, 5, 7, 9, 1, 3],
        "병": [2, 4, 6, 8, 0, 2, 4, 6, 8, 0, 2, 4],
        "정": [3, 5, 7, 9, 1, 3, 5, 7, 9, 1, 3, 5],
        "무": [4, 6, 8, 0, 2, 4, 6, 8, 0, 2, 4, 6],
        "기": [5, 7, 9, 1, 3, 5, 7, 9, 1, 3, 5, 7],
        "경": [6, 8, 0, 2, 4, 6, 8, 0, 2, 4, 6, 8],
        "신": [7, 9, 1, 3, 5, 7, 9, 1, 3, 5, 7, 9],
        "임": [8, 0, 2, 4, 6, 8, 0, 2, 4, 6, 8, 0],
        "계": [9, 1, 3, 5, 7, 9, 1, 3, 5, 7, 9, 1]
    }
    stem_idx = stem_map[day_stem][branch_idx]
    return stems[stem_idx], branches[branch_idx]

def get_five_elements(stem_branch):
    elements_map = {
        "갑": "목", "을": "목", "병": "화", "정": "화", "무": "토", "기": "토",
        "경": "금", "신": "금", "임": "수", "계": "수",
        "자": "수", "해": "수", "인": "목", "묘": "목",
        "사": "화", "오": "화", "진": "토", "술": "토", "축": "토", "미": "토",
        "신": "금", "유": "금"
    }
    stem, branch = stem_branch[0], stem_branch[1]
    return elements_map[stem], elements_map[branch]

def get_twelve_life_forces(day_stem, branch):
    twelve_forces = ["장생", "목욕", "관대", "임관", "대왕", "쇠", "병", "사", "묘", "절", "태", "양"]
    start_points = {
        "갑": "해", "을": "해",
        "병": "인", "정": "인",
        "무": "묘", "기": "묘",
        "경": "오", "신": "오",
        "임": "신", "계": "신"
    }
    branches = ["자", "축", "인", "묘", "진", "사", "오", "미", "신", "유", "술", "해"]
    directions = {
        "갑": 1, "을": -1, "병": 1, "정": -1, "무": 1, "기": -1,
        "경": 1, "신": -1, "임": 1, "계": -1
    }
    start_branch = start_points[day_stem]
    start_idx = branches.index(start_branch)
    branch_idx = branches.index(branch)
    direction = directions[day_stem]
    if direction > 0:
        force_idx = (branch_idx - start_idx) % 12
    else:
        force_idx = (start_idx - branch_idx) % 12
    return twelve_forces[force_idx]

def calculate_major_fortune(year_stem, month_stem, month_branch, birth_day, birth_month, birth_year, gender):
    stems = ["갑", "을", "병", "정", "무", "기", "경", "신", "임", "계"]
    branches = ["자", "축", "인", "묘", "진", "사", "오", "미", "신", "유", "술", "해"]
    def is_leap_year(year):
        return year % 4 == 0 and (year % 100 != 0 or year % 400 == 0)
    days_in_month = [0, 31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31]
    if is_leap_year(birth_year):
        days_in_month[2] = 29
    def get_solar_terms(year, month):
        return 15
    solar_term_day = get_solar_terms(birth_year, birth_month)
    if birth_day <= solar_term_day:
        days_diff = solar_term_day - birth_day
    else:
        prev_month = birth_month - 1 if birth_month > 1 else 12
        prev_year = birth_year if birth_month > 1 else birth_year - 1
        days_diff = days_in_month[prev_month] - birth_day + solar_term_day
    is_yang_stem = stems.index(year_stem) % 2 == 0
    direction = 1 if (gender == "남" and is_yang_stem) or (gender == "여" and not is_yang_stem) else -1
    start_age_months = days_diff // 3 if gender == "남" else days_diff * 3
    start_age_years = start_age_months // 12
    start_age_remainder_months = start_age_months % 12
    month_stem_idx = stems.index(month_stem)
    month_branch_idx = branches.index(month_branch)
    major_fortunes = []
    for i in range(10):
        next_stem_idx = (month_stem_idx + i*direction) % 10
        next_branch_idx = (month_branch_idx + i*direction) % 12
        next_stem = stems[next_stem_idx]
        next_branch = branches[next_branch_idx]
        start_year = birth_year + start_age_years + i*10
        end_year = start_year + 9
        major_fortunes.append({
            "간지": next_stem + next_branch,
            "시작연령": start_age_years + i*10,
            "시작년도": start_year,
            "종료년도": end_year
        })
    return major_fortunes

def calculate_saju(year, month, day, hour, gender, is_lunar=False):
    if is_lunar:
        year, month, day = solar_to_lunar(year, month, day)
    year_stem, year_branch = get_stem_branch_year(year)
    month_stem, month_branch = get_stem_branch_month(year_stem, month)
    day_stem, day_branch = get_stem_branch_day(year, month, day)
    hour_stem, hour_branch = get_stem_branch_hour(day_stem, hour)
    day_master = day_stem
    year_elements = get_five_elements(year_stem + year_branch)
    month_elements = get_five_elements(month_stem + month_branch)
    day_elements = get_five_elements(day_stem + day_branch)
    hour_elements = get_five_elements(hour_stem + hour_branch)
    year_life_force = get_twelve_life_forces(day_stem, year_branch)
    month_life_force = get_twelve_life_forces(day_stem, month_branch)
    day_life_force = get_twelve_life_forces(day_stem, day_branch)
    hour_life_force = get_twelve_life_forces(day_stem, hour_branch)
    major_fortunes = calculate_major_fortune(
        year_stem, month_stem, month_branch, day, month, year, gender
    )
    return {
        "연주": year_stem + year_branch,
        "월주": month_stem + month_branch,
        "일주": day_stem + day_branch,
        "시주": hour_stem + hour_branch,
        "일간": day_master,
        "오행": {
            "연주": year_elements,
            "월주": month_elements,
            "일주": day_elements,
            "시주": hour_elements
        },
        "십이운성": {
            "연주": year_life_force,
            "월주": month_life_force,
            "일주": day_life_force,
            "시주": hour_life_force
        },
        "대운": major_fortunes
    }
```

---

## 5. 주요 구현 복잡성 및 고려사항

- **정확한 음양력 변환**: 천문학적 계산 필요, 윤달 처리, 외부 API 권장 (한국천문연구원 등)
- **정확한 절기 계산**: 각 월의 절입일은 매년 다름(태양 위치 기반)
- **지방시 보정**: 경도에 따른 시간 보정(4분/1도), 표준시/지방시 차이 고려
- **정확한 일주 계산**: 윤년, 시간대, 역법 변화 고려
- **신살(神殺) 및 합충형해 등**: 별도 로직 필요

---
```